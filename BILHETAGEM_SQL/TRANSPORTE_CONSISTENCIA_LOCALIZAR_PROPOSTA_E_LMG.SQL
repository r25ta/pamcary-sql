



--LOCALIZAR INFORMAÇÕES DA AVERBAÇAO
SELECT COALESCE(a.NUM_PROPT,0) AS num_propt
	, c.VLR_EMBAR
	, c.COD_MANIF
	, b.CTL_PESSO 
FROM  averbacao_indice b
INNER JOIN averbacao c ON b.ctl_averb = c.ctl_averb 
LEFT JOIN seguro.tseg_proposta_seguro a ON (a.CTL_CLIEN_PPS,a.NUM_RAMO_SEG) = (b.CTL_PESSO,b.NUM_RAMO) AND A.NUM_VERSA_PRS = 1 AND A.TIP_PROPT = 1  
AND a.sit_tipo_prs = 1  
AND c.dat_embar BETWEEN a.dat_inici_vig AND a.dat_fim_vig 
AND a.NUM_PROPT NOT BETWEEN 55000000 AND 55999999 
AND a.NUM_PROPT NOT BETWEEN 999000000 AND 999999999 
WHERE  b.ctl_averb IN (571720601,
571720602,
571720603,
571720604,
571720605,
571720606,
571720607,
571720608,
571720609,
571720610,
571720611,
571720612,
571720613,
571720614,
571720615
)


--LOCALIZAR NUMERO DA PROPOSTA, VALOR EMBARQUE, COD MANIFESTO E VLR LIMIT  POR AVERBACAO
SELECT  
	b.ctl_averb,
	b.num_propt,
	COALESCE(a.NUM_PROPT,0) AS num_propt
	, c.COD_MANIF
	, COALESCE(c.VLR_EMBAR,0) AS vlr_embar
	, COALESCE(PL.VLR_LIMIT,0) AS vlr_limit 
	, CASE 
		WHEN c.VLR_EMBAR > PL.VLR_LIMIT THEN 'LMG_INVALIDO'
		WHEN c.VLR_EMBAR <= PL.VLR_LIMIT THEN 'LMG_VALIDO'
		ELSE 'LMG_ERRADO'
	END AS LMG
	, b.CTL_PESSO
	, b.CTL_VINCD_SED 
	FROM  averbacao_indice b
INNER JOIN averbacao c ON b.ctl_averb = c.ctl_averb 
LEFT JOIN seguro.tseg_proposta_seguro a ON (a.CTL_CLIEN_PPS,a.NUM_RAMO_SEG) = (b.CTL_PESSO,b.NUM_RAMO) AND A.NUM_VERSA_PRS = 1 AND A.TIP_PROPT = 1
LEFT JOIN SEGURO.TSEG_PROPOSTA_LIMITE PL ON PL.NUM_PROPT = A.NUM_PROPT AND PL.NUM_VERSA_PRS = 1 AND PL.TIP_LIMIT_SEG = 1
WHERE c.dat_embar BETWEEN a.dat_inici_vig AND a.dat_fim_vig 
AND a.NUM_PROPT NOT BETWEEN 55000000 AND 55999999 
AND a.NUM_PROPT NOT BETWEEN 999000000 AND 999999999 
AND b.ctl_averb IN ( SELECT CTL_AVERB FROM APLTRANS.AVERBACAO_ERRO WHERE sta_consist = 0 OR sta_consist IS null )
