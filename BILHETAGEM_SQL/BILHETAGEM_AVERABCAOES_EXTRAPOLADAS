--QUERY PARA RETORNAR AVERBAÇÕES EXTRAPOLADAS
--REGRA DA TELA: O SISTEMA LIBERA PARA EDIÇÃO DO VALOR, SOMENTE AVERBAÇÕES NÃO FATURADAS NUM_ETAPA_AVB = 1

SELECT A.SEQ_NUMER_AVB	
, A.NUM_AVERB_CLI 
, COALESCE(A.NOM_FANTS_CLI || '(' || PESSOACOG.NOM_FANTS || ')', A.NOM_FANTS_CLI)|| CASE WHEN AJ.SEQ_NUMER_PRS IS NOT NULL THEN '(AJ)' ELSE '' END AS NOM_FANTS_CLI
, A.SIG_SIMBO_MOE 
, A.NUM_APOLI 
, A.NUM_SEQUE_AVB 
, A.SIG_RAMO 
, A.DHR_EMBAR 
, A.COD_DOCUM_EMB 
, A.ORIGEM 
, A.DESTINO 
, A.VLR_IS IS 
, A.VLR_IS_TOT IS_TOTAL 
, A.VLR_EMBAR 
, A.VLR_LIMIT_PRS 
, A.VLR_EMBAR - A.VLR_IS VLR_EMBAR_LIMIT_PRS 
, A.SEQ_NUMER_PRS 
, A.CTL_PESSO_CLI 
, A.NUM_AVERB_PAM 
, A.VLR_LIMIT_PTX 
, A.NUM_ETAPA_AVB 	  
 FROM bilhet.V_BIL_CONSULTA_AVERB_PROPT_EXTPO A 
 LEFT JOIN BILHET.TBIL_PROPOSTA PROPOSTA ON A.SEQ_NUMER_PRS = PROPOSTA.SEQ_NUMER_PRS 
 LEFT JOIN BILHET.TBIL_PROPOSTA_AJUSTAVEL AJ ON AJ.SEQ_NUMER_PRS = PROPOSTA.SEQ_NUMER_PRS 
 LEFT JOIN PAMAIS.V_CRP_PESSOA PESSOACOG ON PESSOACOG.CTL_PESSO = PROPOSTA.CTL_PESSO_COG 
 WHERE YEAR(A.DHR_EMBAR) = 2024 
 AND MONTH(A.DHR_EMBAR) = 01
-- AND A.NUM_ETAPA_AVB = 1
-- AND A.NUM_AVERB_PAM IN ( 833173206, 841024301, 140 )
 OPTIMIZE FOR 1 ROWS WITH UR
 
 