create or replace FUNCTION FC_PRACA_MAIS_PROXIMA
(NUM_LATIT VARCHAR2, NUM_LONGI VARCHAR2, TIPO_RETORNO NUMBER)
RETURN
VARCHAR2 AS
RETORNO VARCHAR2(6);
DES_LATIT VARCHAR2(20);
DES_LONGI VARCHAR2(20);
G_LAT_MENOR NUMBER:=0;
M_LAT_MENOR NUMBER:=0;
S_LAT_MENOR NUMBER:=0;
G_LAT_MAIOR NUMBER:=0;
M_LAT_MAIOR NUMBER:=0;
S_LAT_MAIOR NUMBER:=0;
G_LON_MENOR NUMBER:=0;
M_LON_MENOR NUMBER:=0;
S_LON_MENOR NUMBER:=0;
G_LON_MAIOR NUMBER:=0;
M_LON_MAIOR NUMBER:=0;
S_LON_MAIOR NUMBER:=0;
--
VG_LAT_MENOR VARCHAR2(2);
VM_LAT_MENOR VARCHAR2(2);
VS_LAT_MENOR VARCHAR2(2);
VG_LAT_MAIOR VARCHAR2(2);
VM_LAT_MAIOR VARCHAR2(2);
VS_LAT_MAIOR VARCHAR2(2);
VG_LON_MENOR VARCHAR2(2);
VM_LON_MENOR VARCHAR2(2);
VS_LON_MENOR VARCHAR2(2);
VG_LON_MAIOR VARCHAR2(2);
VM_LON_MAIOR VARCHAR2(2);
VS_LON_MAIOR VARCHAR2(2);
--
DES_LATIT_MENOR VARCHAR2(6);
DES_LATIT_MAIOR VARCHAR2(6);
DES_LONGI_MENOR VARCHAR2(6);
DES_LONGI_MAIOR VARCHAR2(6);
--
CONTADOR  NUMBER:=0;
MENOR     NUMBER:=0;
DISTANCIA NUMBER:=0;
--
CURSOR C1(COORDENADA NUMBER, TIPO_SAIDA NUMBER) IS
	SELECT NVL(FC_CONV_COORDENADA_DEC_GEO(COORDENADA,TIPO_SAIDA),000000) AS COORD FROM DUAL;
RC1 C1%ROWTYPE;
--
CURSOR C2(DES_LATIT_MENOR VARCHAR2, DES_LATIT_MAIOR VARCHAR2, DES_LONGI_MENOR VARCHAR2, DES_LONGI_MAIOR VARCHAR2) IS
	SELECT NVL(ctl_vincd, 0) AS ctl_vincd,
	       NVL(des_latit,'000000') AS des_latit, 
	       NVL(des_longi,'000000') AS des_longi	
	FROM ENDERECO_VINCULADO
	WHERE des_latit BETWEEN DES_LATIT_MENOR AND DES_LATIT_MAIOR
	AND des_longi BETWEEN DES_LONGI_MENOR AND DES_LONGI_MAIOR;
RC2 C2%ROWTYPE;
--
CURSOR C3(DES_LATIT VARCHAR2, DES_LONGI VARCHAR2) IS
	SELECT NVL(cod_praca,0) AS cod_praca
	FROM PRACA
	WHERE num_latit = DES_LATIT
	AND num_longi = DES_LONGI;
RC3 C3%ROWTYPE;
BEGIN
	IF TIPO_RETORNO = 1 THEN
		--
		DES_LATIT := NUM_LATIT;
		IF INSTR(DES_LATIT,'-') > 0 THEN
			DES_LATIT := SUBSTR(DES_LATIT,2,LENGTH(DES_LATIT));
		END IF;
		DES_LONGI := NUM_LONGI;
		IF INSTR(DES_LONGI,'-') > 0 THEN
			DES_LONGI := SUBSTR(DES_LONGI,2,LENGTH(DES_LATIT));
		END IF;	
		G_LAT_MENOR := SUBSTR(DES_LATIT,1,2); 
		M_LAT_MENOR := SUBSTR(DES_LATIT,3,2);
		S_LAT_MENOR := SUBSTR(DES_LATIT,(LENGTH(DES_LATIT)-1),2) - 15;
		G_LAT_MAIOR := SUBSTR(DES_LATIT,1,2);
		M_LAT_MAIOR := SUBSTR(DES_LATIT,3,2);
		S_LAT_MAIOR := SUBSTR(DES_LATIT,(LENGTH(DES_LATIT)-1),2) + 15;
		IF(S_LAT_MENOR<0)THEN
			S_LAT_MENOR := 60 - ABS(S_LAT_MENOR);
			M_LAT_MENOR := SUBSTR(DES_LATIT,(LENGTH(DES_LATIT)-3),2) - 1;
			IF(M_LAT_MENOR<0) THEN
				M_LAT_MENOR := 60 - ABS(M_LAT_MENOR);
				G_LAT_MENOR := SUBSTR(DES_LATIT,(LENGTH(DES_LATIT)-6),2) - 1;
			END IF;
		END IF;
		IF(S_LAT_MAIOR>59)THEN
			S_LAT_MAIOR := SUBSTR(DES_LATIT,(LENGTH(DES_LATIT)-1),2)-60;
			M_LAT_MAIOR := SUBSTR(DES_LATIT,(LENGTH(DES_LATIT)-3),2) + 1;
			IF(M_LAT_MAIOR>59) THEN
				M_LAT_MAIOR := SUBSTR(DES_LATIT,(LENGTH(DES_LATIT)-3),2)-60;
				G_LAT_MAIOR := SUBSTR(DES_LATIT,(LENGTH(DES_LATIT)-6),2) + 1;
			END IF;
		END IF;
		G_LON_MENOR := SUBSTR(DES_LONGI,1,2); 
		M_LON_MENOR := SUBSTR(DES_LONGI,3,2);
		S_LON_MENOR := SUBSTR(DES_LONGI,(LENGTH(DES_LONGI)-1),2) - 15;
		G_LON_MAIOR := SUBSTR(DES_LONGI,1,2);
		M_LON_MAIOR := SUBSTR(DES_LONGI,3,2);
		S_LON_MAIOR := SUBSTR(DES_LONGI,(LENGTH(DES_LONGI)-1),2) + 15;
		IF(S_LON_MENOR<0)THEN
			S_LON_MENOR := 60 - ABS(S_LON_MENOR);
			M_LON_MENOR := SUBSTR(DES_LONGI,(LENGTH(DES_LONGI)-3),2) - 1;
			IF(M_LON_MENOR<0) THEN
				M_LON_MENOR := 60 - ABS(M_LON_MENOR);
				G_LON_MENOR := SUBSTR(DES_LONGI,(LENGTH(DES_LONGI)-6),2) - 1;
			END IF;
		END IF;
		IF(S_LON_MAIOR>59)THEN
			S_LAT_MAIOR := SUBSTR(DES_LONGI,(LENGTH(DES_LONGI)-1),2)-60;
			M_LAT_MAIOR := SUBSTR(DES_LONGI,(LENGTH(DES_LONGI)-3),2) + 1;
			IF(M_LAT_MAIOR>59) THEN
				M_LAT_MAIOR := SUBSTR(DES_LONGI,(LENGTH(DES_LONGI)-3),2)-60;
				G_LAT_MAIOR := SUBSTR(DES_LONGI,(LENGTH(DES_LONGI)-6),2) + 1;
			END IF;
		END IF;
		--
		DES_LATIT_MENOR	:= FC_FORMATA_COORDENADA_GEO(G_LAT_MENOR,M_LAT_MENOR,S_LAT_MENOR);
		DES_LATIT_MAIOR	:= FC_FORMATA_COORDENADA_GEO(G_LAT_MAIOR,M_LAT_MAIOR,S_LAT_MAIOR);
		DES_LONGI_MENOR	:= FC_FORMATA_COORDENADA_GEO(G_LON_MENOR,M_LON_MENOR,S_LON_MENOR);
		DES_LONGI_MAIOR	:= FC_FORMATA_COORDENADA_GEO(G_LON_MAIOR,M_LON_MAIOR,S_LON_MAIOR);
		--		
		OPEN C2(DES_LATIT_MENOR, DES_LATIT_MAIOR, DES_LONGI_MENOR, DES_LONGI_MAIOR);
		  LOOP
		    FETCH C2 INTO RC2;
		      IF C2%NOTFOUND THEN
			 EXIT;
		      END IF;
	---------------------------------------------------------------------------------------------------------
		      DISTANCIA := FC_DISTANCIA_PONTOS_INFOLOG(NUM_LATIT, NUM_LONGI, RC2.DES_LATIT, RC2.DES_LONGI);
	---------------------------------------------------------------------------------------------------------
		      IF DISTANCIA < MENOR OR CONTADOR = 0 THEN
			       MENOR := DISTANCIA;
			       RETORNO := RC2.CTL_VINCD;
		      END IF;
		      CONTADOR := CONTADOR + 1;
		  END LOOP;
		CLOSE C2;
	ELSIF TIPO_RETORNO = 2 THEN
		OPEN C1(NUM_LATIT,TIPO_RETORNO);
		FETCH C1 INTO RC1;
		IF C1%FOUND THEN
			DES_LATIT := RC1.COORD;
		END IF;
		CLOSE C1;
	END IF;
	RETURN RETORNO;
END;