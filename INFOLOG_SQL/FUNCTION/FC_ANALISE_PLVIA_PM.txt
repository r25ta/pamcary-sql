CREATE OR REPLACE
FUNCTION FC_ANALISE_PLVIA_PM(PCTL_VIA NUMBER)
RETURN NUMBER
AS
CURSOR
 PLVIA IS
 SELECT ctl_plvia, SUBSTR(RPAD(to_char(cod_ocorr),5,0),1,2) as cod_ocorr, count(*) AS qtd
   FROM SUPERVISOR.ANALISE_PLANO_VIAGEM
  WHERE ctl_plvia = PCTL_VIA
    AND SUBSTR(RPAD(to_char(cod_ocorr),5,0),1,2) = '10'
    AND SUBSTR(RPAD(to_char(cod_ocorr),5,0),5,1) = '2'
  GROUP BY ctl_plvia, SUBSTR(RPAD(to_char(cod_ocorr),5,0),1,2);

 RPLVIA PLVIA%ROWTYPE;

BEGIN
 OPEN PLVIA;
 FETCH PLVIA INTO RPLVIA;
 IF PLVIA%NOTFOUND THEN
    RETURN(NULL);
 END IF;
 CLOSE PLVIA;
 RETURN(RPLVIA.qtd);
END;
/
